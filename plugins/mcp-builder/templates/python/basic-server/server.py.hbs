"""
{{serverName}} - MCP Server
Generated by MCP Builder Plugin

A simple MCP server demonstrating core patterns.
"""

import os
import json
from typing import Optional
from dotenv import load_dotenv
from fastmcp import FastMCP
from pydantic import BaseModel, Field, ConfigDict

# Load environment
load_dotenv()

# Initialize MCP server
mcp = FastMCP("{{serverName}}")

# =============================================================================
# INPUT SCHEMAS
# =============================================================================

class HelloInput(BaseModel):
    """Input schema for hello tool."""
    name: str = Field(..., description="Name to greet")
    formal: bool = Field(False, description="Use formal greeting")

    model_config = ConfigDict(extra="forbid")


# =============================================================================
# TOOLS
# =============================================================================

@mcp.tool()
def hello(name: str, formal: bool = False) -> str:
    """Greet someone by name.

    Returns a personalized greeting message. Use this tool when
    the user wants to say hello or get a greeting.

    Args:
        name: The name of the person to greet
        formal: Whether to use formal language (default: informal)

    Returns:
        A greeting message
    """
    if formal:
        return f"Good day, {name}. It is a pleasure to make your acquaintance."
    return f"Hey {name}! Great to see you!"


@mcp.tool()
def echo(message: str) -> str:
    """Echo back a message.

    Returns the exact message that was sent. Use this tool to test
    that the server is responding correctly.

    Args:
        message: The message to echo back

    Returns:
        The same message
    """
    return message


# =============================================================================
# RESOURCES
# =============================================================================

@mcp.resource("info://server")
def get_server_info() -> str:
    """Server information and capabilities.

    Read this resource to understand what this server can do.
    """
    return json.dumps({
        "name": "{{serverName}}",
        "version": "1.0.0",
        "description": "{{serverDescription}}",
        "tools": ["hello", "echo"],
        "resources": ["info://server"]
    }, indent=2)


# =============================================================================
# CUSTOM ROUTES
# =============================================================================

from starlette.responses import JSONResponse, PlainTextResponse

@mcp.custom_route("/health", methods=["GET"])
async def health_check(request):
    """Health check endpoint for deployment platforms."""
    return JSONResponse({"status": "healthy", "server": "{{serverName}}"})


@mcp.custom_route("/info", methods=["GET"])
async def server_info(request):
    """Server information endpoint."""
    return JSONResponse({
        "name": "{{serverName}}",
        "version": "1.0.0",
        "tools": 2,
        "resources": 1
    })


# =============================================================================
# MAIN
# =============================================================================

if __name__ == "__main__":
    import uvicorn

    port = int(os.environ.get("PORT", 8000))
    host = os.environ.get("HOST", "0.0.0.0")

    print(f"""
{'='*50}
  {{serverName}} MCP Server
{'='*50}
  Port:     {port}
  Health:   http://{host}:{port}/health
  MCP:      http://{host}:{port}/mcp
{'='*50}
    """)

    # Run with FastMCP's HTTP app
    app = mcp.http_app(path="/mcp")
    uvicorn.run(app, host=host, port=port)
