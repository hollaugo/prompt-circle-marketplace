"""
{{serverName}} - MCP Server
Generated by MCP Builder Plugin

Transport: Streamable HTTP (recommended for web deployment)
Pattern: Basic

Test with MCP Inspector:
  ./START.sh --inspector
  Or: npx @modelcontextprotocol/inspector
  Connect to: http://localhost:8000/mcp
"""

import os
import json
from typing import Optional
from dotenv import load_dotenv
from fastmcp import FastMCP
from pydantic import BaseModel, Field, ConfigDict
from starlette.responses import JSONResponse, PlainTextResponse
from starlette.middleware import Middleware
from starlette.middleware.cors import CORSMiddleware

# Load environment
load_dotenv()

# =============================================================================
# CONFIGURATION
# =============================================================================

PORT = int(os.environ.get("PORT", 8000))
HOST = os.environ.get("HOST", "0.0.0.0")
NODE_ENV = os.environ.get("NODE_ENV", "development")

# Initialize MCP server with Streamable HTTP transport
mcp = FastMCP(
    name="{{serverName}}",
    # SSE path for streaming responses
    sse_path="/mcp",
    message_path="/mcp/messages",
    stateless_http=True,
)

# =============================================================================
# INPUT SCHEMAS
# =============================================================================

class HelloInput(BaseModel):
    """Input schema for hello tool."""
    name: str = Field(..., description="Name to greet")
    formal: bool = Field(False, description="Use formal greeting")

    model_config = ConfigDict(extra="forbid")


# =============================================================================
# TOOLS
# =============================================================================

@mcp.tool()
def hello(name: str, formal: bool = False) -> str:
    """Greet someone by name.

    Returns a personalized greeting message. Use this tool when
    the user wants to say hello or get a greeting.

    Args:
        name: The name of the person to greet
        formal: Whether to use formal language (default: informal)

    Returns:
        A greeting message
    """
    if formal:
        return f"Good day, {name}. It is a pleasure to make your acquaintance."
    return f"Hey {name}! Great to see you!"


@mcp.tool()
def echo(message: str) -> str:
    """Echo back a message.

    Returns the exact message that was sent. Use this tool to test
    that the server is responding correctly.

    Args:
        message: The message to echo back

    Returns:
        The same message
    """
    return message


# =============================================================================
# RESOURCES
# =============================================================================

@mcp.resource("info://server")
def get_server_info() -> str:
    """Server information and capabilities.

    Read this resource to understand what this server can do.
    """
    return json.dumps({
        "name": "{{serverName}}",
        "version": "1.0.0",
        "description": "{{serverDescription}}",
        "transport": "Streamable HTTP",
        "tools": ["hello", "echo"],
        "resources": ["info://server"]
    }, indent=2)


# =============================================================================
# CUSTOM ROUTES
# =============================================================================

@mcp.custom_route("/health", methods=["GET"])
async def health_check(request):
    """Health check endpoint for deployment platforms."""
    return JSONResponse({"status": "healthy", "server": "{{serverName}}"})


@mcp.custom_route("/info", methods=["GET"])
async def server_info(request):
    """Server information endpoint."""
    return JSONResponse({
        "name": "{{serverName}}",
        "version": "1.0.0",
        "transport": "streamable-http",
        "tools": 2,
        "resources": 1
    })


# =============================================================================
# MAIN
# =============================================================================

if __name__ == "__main__":
    import uvicorn

    print(f"""
{'='*60}
  {{serverName}} MCP Server
{'='*60}
  Transport:  Streamable HTTP
  Port:       {PORT}
  Environment: {NODE_ENV}

  Endpoints:
    MCP:      http://{HOST}:{PORT}/mcp
    Health:   http://{HOST}:{PORT}/health
    Info:     http://{HOST}:{PORT}/info

  Test with MCP Inspector:
    npx @modelcontextprotocol/inspector
    Connect to: http://localhost:{PORT}/mcp
    Transport: Streamable HTTP
{'='*60}
    """)

    # CORS middleware for web clients
    cors_middleware = [
        Middleware(
            CORSMiddleware,
            allow_origins=["*"],
            allow_methods=["GET", "POST", "PUT", "DELETE", "OPTIONS"],
            allow_headers=["*"],
        )
    ]

    # Create HTTP app with Streamable HTTP transport
    app = mcp.http_app(path="/mcp", middleware=cors_middleware)
    uvicorn.run(app, host=HOST, port=PORT)
